---
resources:
- name: cli
  type: git
  source:
    uri: git@github.com:cloudfoundry/cli
    private_key: {{release-pipeline-ssh-key}}
    branch: master
    ignore_paths:
    - ci

- name: cli-ci
  type: git
  source:
    uri: git@github.com:cloudfoundry/cli
    private_key: {{release-pipeline-ssh-key}}
    branch: master
    paths:
    - ci

- name: edge-linux-binary-32
  type: s3
  source:
    bucket: cf-cli-releases
    access_key_id: {{cli-production-release-access-key-id}}
    secret_access_key: {{cli-production-release-secret-access-key}}
    versioned_file: master/cf-cli_edge_linux_i686.tgz
    region_name: us-west-1

- name: edge-linux-binary-64
  type: s3
  source:
    bucket: cf-cli-releases
    access_key_id: {{cli-production-release-access-key-id}}
    secret_access_key: {{cli-production-release-secret-access-key}}
    versioned_file: master/cf-cli_edge_linux_x86-64.tgz
    region_name: us-west-1

- name: edge-osx-binary-64
  type: s3
  source:
    bucket: cf-cli-releases
    access_key_id: {{cli-production-release-access-key-id}}
    secret_access_key: {{cli-production-release-secret-access-key}}
    versioned_file: master/cf-cli_edge_osx.tgz
    region_name: us-west-1

- name: edge-windows-binary-32
  type: s3
  source:
    bucket: cf-cli-releases
    access_key_id: {{cli-production-release-access-key-id}}
    secret_access_key: {{cli-production-release-secret-access-key}}
    versioned_file: master/cf-cli_edge_win32.zip
    region_name: us-west-1

- name: edge-windows-binary-64
  type: s3
  source:
    bucket: cf-cli-releases
    access_key_id: {{cli-production-release-access-key-id}}
    secret_access_key: {{cli-production-release-secret-access-key}}
    versioned_file: master/cf-cli_edge_winx64.zip
    region_name: us-west-1

- name: edge-deb-installer-32
  type: s3
  source:
    bucket: cf-cli-releases
    access_key_id: {{cli-production-release-access-key-id}}
    secret_access_key: {{cli-production-release-secret-access-key}}
    versioned_file: master/cf-cli-installer_edge_i686.deb
    region_name: us-west-1

- name: edge-deb-installer-64
  type: s3
  source:
    bucket: cf-cli-releases
    access_key_id: {{cli-production-release-access-key-id}}
    secret_access_key: {{cli-production-release-secret-access-key}}
    versioned_file: master/cf-cli-installer_edge_x86-64.deb
    region_name: us-west-1

- name: edge-redhat-installer-32
  type: s3
  source:
    bucket: cf-cli-releases
    access_key_id: {{cli-production-release-access-key-id}}
    secret_access_key: {{cli-production-release-secret-access-key}}
    versioned_file: master/cf-cli-installer_edge_i686.rpm
    region_name: us-west-1

- name: edge-redhat-installer-64
  type: s3
  source:
    bucket: cf-cli-releases
    access_key_id: {{cli-production-release-access-key-id}}
    secret_access_key: {{cli-production-release-secret-access-key}}
    versioned_file: master/cf-cli-installer_edge_x86-64.rpm
    region_name: us-west-1

- name: edge-osx-installer-64
  type: s3
  source:
    bucket: cf-cli-releases
    access_key_id: {{cli-production-release-access-key-id}}
    secret_access_key: {{cli-production-release-secret-access-key}}
    versioned_file: master/cf-cli-installer_edge_osx.pkg
    region_name: us-west-1

jobs:
- name: create-and-sign-installers
  serial: true
  plan:
  - aggregate:
    - get: cli-ci
      params:
        depth: 2
    - get: edge-linux-binary-32
    - get: edge-linux-binary-64
    - get: edge-osx-binary-64
    - get: edge-windows-binary-32
    - get: edge-windows-binary-64
    - get: edge-deb-installer-32
    - get: edge-deb-installer-64
    - get: edge-redhat-installer-32
    - get: edge-redhat-installer-64
    - get: edge-osx-installer-64

  - task: obtain-certificates
    file: cli-ci/ci/cli-release/tasks/obtain-certificates.yml
    params:
      CERT_PATH: {{osx-certificate-store}}
  - task: copy-certificates
    file: cli-ci/ci/cli-release/tasks/copy-certificates.yml

  - task: repackage-binaries-and-installers
    file: cli-ci/ci/cli-release/tasks/repackage-binaries-and-installers.yml
  - task: sign-osx-installer
    file: cli-ci/ci/cli-release/tasks/sign-osx-installer.yml
    params:
      CERT_COMMON_NAME: {{osx-certificate-common-name}}
      CERT_LOCATION: {{osx-certificate-location}}
      CERT_PASSWORD_LOCATION: {{osx-certificate-password-location}}
  - task: sign-redhat-installers
    file: cli-ci/ci/cli-release/tasks/sign-redhat-installers.yml
    params:
      GPG_KEY_LOCATION: {{gpg-key-location}}
#   - do:
#     - task: sign-windows-binaries
#       file: cli-ci/ci/cli-release/tasks/sign-windows-binaries.yml
#     - task: create-windows-installers
#       file: cli-ci/ci/cli/tasks/create-windows-installers.yml
#     - task: sign-windows-installers
#       file: cli-ci/ci/cli/tasks/sign-windows-installers

  - task: upload-releases
    file: cli-ci/ci/cli-release/tasks/upload-releases.yml
    params:
      AWS_ACCESS_KEY_ID: {{cli-production-release-access-key-id}}
      AWS_SECRET_ACCESS_KEY: {{cli-production-release-secret-access-key}}

- name: update-claw
  serial: true
  plan:
  - aggregate:
    - get: cli-ci
      trigger: true
      passed: [create-and-sign-installers]
      params:
        depth: 2
    - get: edge-linux-binary-64
      passed: [create-and-sign-installers]
  - aggregate:
    - task: claw.run.pivotal.io
      file: cli-ci/ci/cli-release/tasks/update-claw.yml
      params:
        CF_API: {{cf-api}}
        CF_USERNAME: {{cf-username}}
        CF_PASSWORD: {{cf-password}}
        CF_ORGANIZATION: {{pivotal-organization}}
        CF_SPACE: {{pivotal-space}}
    - task: packages.cloudfoundry.org
      file: cli-ci/ci/cli-release/tasks/update-claw.yml
      params:
        CF_API: {{cf-api}}
        CF_USERNAME: {{cf-username}}
        CF_PASSWORD: {{cf-password}}
        CF_ORGANIZATION: {{oss-organization}}
        CF_SPACE: {{oss-space}}

- name: update-debian-repo
  serial: true
  plan:
  - get: cli-ci
    trigger: true
    passed: [update-claw]
    params:
      depth: 2
  - task: publish-debian
    file: cli-ci/ci/cli-release/tasks/publish-debian.yml
    params:
      GPG_KEY_LOCATION: {{gpg-key-location}}
      KEY_ID: {{gpg-key-id-location}}
      AWS_ACCESS_KEY_ID: {{cli-production-release-access-key-id}}
      AWS_SECRET_ACCESS_KEY: {{cli-production-release-secret-access-key}}
      AWS_BUCKET_NAME: cf-cli-debian-repo
